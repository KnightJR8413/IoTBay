<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoTBay - Order History</title>
    <link rel="stylesheet" href="{{ url_for('serve_css', filename='styles.css')}}">
</head>
<body>
    <!-- HEADER -->
    <div class="navbar">
        <div class="logo">
            <a href="/index">
                <img src="{{ url_for('serve_images', filename='logo.png') }}" width="125px" alt="IoTBay Logo">
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="/index">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/products">Products</a></li>
                <li><a href="/contact">Contact</a></li>                
            </ul>
        </nav>
        <div class="icon-buttons">
            <button class="icon-btn" onclick="toggleSearchBar();">
                <img src="{{ url_for('serve_images', filename='search.png') }}" alt="search" class="icon-img">
            </button>
            <button class="icon-btn" onclick="checkLoginAndRedirect();">
                <img src="{{ url_for('serve_images', filename='login.png') }}" alt="login" class="icon-img">
            </button>                
            <button class="icon-btn" onclick="location.href='/shoppingcart';">
                <img src="{{ url_for('serve_images', filename='cart.png') }}" alt="shoppingcart" class="icon-img">
            </button>
        </div>
    </div>

    <div id="search-bar" class="search-bar">
        <input type="text" placeholder="Search products..." id="search-input">
        <button onclick="searchProduct()">Search</button>
        <button onclick="toggleSearchBar()">Close</button>
    </div>

    <!-- HERO -->
    <section class="hero">
        <h1>Order History</h1>
    </section>

    <!-- MAIN ORDER HISTORY SECTION -->
    <main class="order-history">
        <div class="order-history-header">
            <h1>Your Orders</h1>
        </div>
        <button class="login-button" onclick='location.href="/paymenthistory2";'>View Payment History</button>

        <!-- Filters Section -->
        <div class="order-filters">
            <div class="filter-group">
                <label>Order #</label>
                <input type="text" placeholder="Order Number" class="reference-filter">
            </div>
            <div class="filter-group">
                <label>FROM DATE</label>
                <input type="date" class="date-filter">
            </div>
            <div class="filter-group">
                <label>TO DATE</label>
                <input type="date" class="date-filter">
            </div>
            <div class="filter-actions">
                <button class="btn-clear" onclick="clearFilters()">CLEAR</button>
                <button class="btn-search" onclick="applyFilters()">SEARCH</button>
            </div>
        </div>

        <!-- Orders Table -->
        <table class="orders-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Items</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="order-history-body">
  <!-- will be injected -->
</tbody>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const API = 'http://localhost:3000';
    const userId = localStorage.getItem('userId');
    if (!userId) return alert('Please log in first.');

    // load & render history
    function fetchHistory() {
      fetch(`${API}/order-history?userId=${userId}`)
        .then(r => r.json())
        .then(data => {
          const tbody = document.getElementById('order-history-body');
          tbody.innerHTML = '';
          if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="5">No past orders found.</td></tr>`;
            return;
          }
          data.forEach(order => {
            const total = order.items
                          .reduce((sum, i) => sum + i.price * i.quantity, 0)
                          .toFixed(2);
            const count = order.items
                          .reduce((sum, i) => sum + i.quantity, 0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>ORD-${order.order_id}</td>
              <td>${new Date(order.order_date).toLocaleString()}</td>
              <td>$${total}</td>
              <td>${count} item${count>1?'s':''}</td>
              <td class="actions">
                <button class="btn-view" onclick="viewOrderDetails(${order.order_id})">
                  View Order Details
                </button>
                <button class="btn-payment" onclick="viewPaymentDetails(${order.order_id})">
                  View Payment Details
                </button>
                <button class="btn-cancel" onclick="cancelOrder(${order.order_id})">
                  Cancel
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(e => console.error('Error fetching order history:', e));
    }

    // go to a details page
    window.viewOrderDetails = id =>
      window.location.href = `/order-details.html?orderId=${id}`;

    // simple passâ€through
    window.viewPaymentDetails = id =>
      window.location.href = `/payment-details.html?orderId=${id}`;

    // cancel and reload
    window.cancelOrder = rawId => {
      // ensure numeric
      const orderId = typeof rawId === 'string'
        ? parseInt(rawId.replace(/^ORD-/, ''), 10)
        : rawId;

      if (!confirm(`Are you sure you want to cancel order ORD-${orderId}?`))
        return;

      fetch(`${API}/orders/${orderId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
      .then(r => {
        if (!r.ok) return r.json().then(j => Promise.reject(j.message));
        return r.json();
      })
      .then(() => {
        alert(`Order ORD-${orderId} cancelled.`);
        fetchHistory();
      })
      .catch(msg => {
        console.error('Cancel order failed:', msg);
        alert(`Could not cancel order: ${msg}`);
      });
    };

    // kick it off
    fetchHistory();
  });
</script>

        </table>
    </main>

    <!-- FOOTER -->
    <div class="footer-newsletter">
        <h2>Get the Latest in Tech News, Deals & Giveaways!</h2>
        <div class="newsletter-form">
            <form>
                <input type="email" placeholder="Only an email away..." required>
                <button type="submit">Sign me up!</button>
            </form>
        </div>
    </div>

    <div class="footer-links">
        <div class="footer-column">
            <h3>ABOUT</h3>
            <ul>
                <li><a href="/about">About Us</a></li>
                <li><a href="/contact">Contact Us</a></li>
                <li><a href="#">Payment Methods</a></li>
                <li><a href="#">Shipping Methods</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>HELP</h3>
            <ul>
                <li><a href="#">FAQ</a></li>
                <li><a href="#">Support</a></li>
                <li><a href="#">Warranty & Returns</a></li>
                <li><a href="#">Services</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>OTHER</h3>
            <ul>
                <li><a href="#">Announcements</a></li>
                <li><a href="#">Careers at IoTBay</a></li>
                <li><a href="/termconditions">Terms & Conditions</a></li>
                <li><a href="/privacypolicy">Privacy Policy</a></li>
            </ul>
        </div>

        <div class="footer-column">
            <h3>Need advice?</h3>
            <p style="color: white"> Speak to our friendly staff</p>
            <a href="/contact" class="contact-button">Contact Us</a>
        </div>
    </div>

    <div class="footer-copyright">
        <p> Copyright &copy; 1999-2025. IoTBay. ABN #68 345 917 426. All Rights Reserved. All prices include GST.</p>
    </div>

    <div class="subscription-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Thank you for subscribing!</h3>
            <p>Your email address <span class="subscribed-email"></span> has been added to the IoTBay mailing list.</p>
        </div>
    </div>
    <div class="modal-backdrop"></div>

    <!-- Scripts -->
    <script src="{{ url_for('serve_js', filename='script.js')}}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('Please log in to view your order history.');
                return;
            }

            fetch(`http://localhost:3000/order-history?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('order-history-body');
                    tbody.innerHTML = '';

                    if (!data.length) {
                        tbody.innerHTML = `<tr><td colspan="5">No past orders found.</td></tr>`;
                        return;
                    }

                    data.forEach(order => {
                        const total = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
                        const itemCount = order.items.reduce((sum, item) => sum + item.quantity, 0);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>ORD-${order.order_id}</td>
                            <td>${new Date(order.order_date).toLocaleString()}</td>
                            <td>$${total}</td>
                            <td>${itemCount} item${itemCount > 1 ? 's' : ''}</td>
                            <td class="actions">
                                <button class="btn-view" onclick="viewOrderDetails('ORD-${order.order_id}')">
                                    View Order Details
                                </button>
                                <button class="btn-payment" onclick="viewPaymentDetails('ORD-${order.order_id}')">
                                    View Payment Details
                                </button>
                                <button class="btn-cancel" onclick="cancelOrder('ORD-${order.order_id}')">
                                    Cancel
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(err => {
                    console.error('Error fetching order history:', err);
                });
        });
    </script>
</body>
</html>

